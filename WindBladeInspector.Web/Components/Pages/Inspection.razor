@page "/inspection"
@page "/inspection/{ProjectId:guid}"
@using WindBladeInspector.Core.Services
@using WindBladeInspector.Core.Entities
@using WindBladeInspector.Core.Interfaces
@using Microsoft.JSInterop
@inject DashboardService DashboardService
@inject InspectionCalculationService CalculationService
@inject IFileStorageService FileStorageService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject ILogger<Inspection> Logger
@rendermode InteractiveServer
@implements IAsyncDisposable

<PageTitle>AeroEdge - Blade Inspection</PageTitle>

<div class="app-container @(_isVisualMode ? "visual-mode" : "")">
    <header class="app-header">
        <h1>
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C13.1 2 14 2.9 14 4V9.5C14 10.9 14.8 12.1 16 12.7V4C16 2.9 16.9 2 18 2S20 2.9 20 4V13C20 17.4 16.4 21 12 21S4 17.4 4 13V4C4 2.9 4.9 2 6 2S8 2.9 8 4V12.7C9.2 12.1 10 10.9 10 9.5V4C10 2.9 10.9 2 12 2Z"/>
            </svg>
            @(_project?.TurbineId ?? "Blade Inspection")
        </h1>
        <div class="header-nav">
            <span style="color: var(--text-muted); margin-right: 1rem;">@(_project?.Model ?? "")</span>
            <button class="btn btn-secondary btn-sm" @onclick="NavigateBack">
                ‚Üê Back to Dashboard
            </button>
        </div>
    </header>

    <div class="inspection-layout">
        <!-- LEFT SIDEBAR: Blade Navigation -->
        <div class="blade-schematic-panel">
            <div class="panel-title">Blade Inspection</div>
            
            <!-- Blade Selector -->
            <div class="blade-selector">
                @if (_project != null)
                {
                    @foreach (var blade in _project.Blades)
                    {
                        <button class="blade-selector-btn @(_selectedBlade?.Id == blade.Id ? "active" : "")"
                                @onclick="() => SelectBlade(blade)">
                            @blade.SerialNumber
                        </button>
                    }
                }
            </div>
            
            <!-- View/Side Selector -->
            @if (_selectedBlade != null)
            {
                <div class="nav-section" style="margin-top: 1rem;">
                    <div class="nav-title">Blade Views</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        @foreach (var view in new[] { "PS", "SS", "LE", "TE" })
                        {
                            var bladeView = _selectedBlade.Views.FirstOrDefault(v => v.Side == view);
                            var imageCount = bladeView?.Images.Count ?? 0;
                            <button class="view-selector-btn @(_selectedView == view ? "active" : "")"
                                    @onclick="() => SelectView(view)"
                                    style="flex: 1; min-width: 40%; position: relative;">
                                <span>@GetViewLabel(view)</span>
                                @if (imageCount > 0)
                                {
                                    <span style="font-size: 0.7rem; display: block; color: #0f0;">@imageCount img</span>
                                }
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- Upload Button -->
            <div class="nav-section" style="margin-top: 1rem;">
                <label class="btn-upload-full" for="bulkFileInput">
                    <span style="font-size: 1.2rem;">+</span> Upload Images for @_selectedView
                </label>
                <InputFile OnChange="HandleBulkFileUpload" multiple style="display: none;" id="bulkFileInput" accept=".jpg,.jpeg,.png,.webp" />
            </div>

            <!-- Simplified Anomaly List -->
            <div class="nav-section" style="margin-top: 1rem; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div class="nav-title">Defect Summary</div>
                <div class="anomaly-list" style="overflow-y: auto;">
                    @if (_selectedBlade != null && _selectedBlade.Anomalies.Any())
                    {
                        foreach (var anomaly in _selectedBlade.Anomalies.OrderByDescending(a => a.Severity))
                        {
                             <div class="anomaly-list-item @(_selectedAnomaly?.Id == anomaly.Id ? "selected" : "")"
                                 @onclick="() => SelectAnomaly(anomaly)">
                                <div class="anomaly-severity-dot severity-dot-@anomaly.Severity"></div>
                                <div class="anomaly-list-info">
                                    <div class="anomaly-list-type">@anomaly.Type</div>
                                    <div class="anomaly-list-location">Severity @anomaly.Severity ‚Ä¢ @anomaly.BladeSide</div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state-text">No defects recorded</div>
                    }
                </div>
            </div>

        </div>
        
        <!-- CENTER PANEL (Header + Canvas) -->
        <div class="center-panel" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Top Image Navigation Bar -->
            <div class="image-navigation-bar">
                <div class="image-nav-content">
                    <button class="nav-arrow-btn" @onclick="PrevImage" disabled="@(!CanNavigatePrev())" title="Previous Image (Left Arrow)">
                        ‚ùÆ
                    </button>
                    
                    <div class="image-number-list">
                        @if (_selectedViewImages.Count > 0)
                        {
                            @for (int i = 0; i < _selectedViewImages.Count; i++)
                            {
                                var img = _selectedViewImages[i];
                                var index = i;
                                var isActive = _selectedImage?.Id == img.Id;
                                var hasDefects = img.Anomalies.Any();
                                
                               <button class="image-number-btn @(isActive ? "active" : "") @(hasDefects ? "has-defects" : "")"
                                        @onclick="() => SelectImageDirect(img)"
                                        title="@($"Image {index + 1}{(hasDefects ? $" ({img.Anomalies.Count} defects)" : "")}")">
                                        @(index + 1)
                               </button>
                            }
                        }
                        else
                        {
                            <span style="color: #666; font-size: 0.85rem; padding: 0 15px;">No images for @_selectedView</span>
                        }
                    </div>
                    
                    <button class="nav-arrow-btn" @onclick="NextImage" disabled="@(!CanNavigateNext())" title="Next Image (Right Arrow)">
                        ‚ùØ
                    </button>
                    
                    <div class="image-info-compact">
                        @if (_selectedImage != null)
                        {
                            <span>Image @(_selectedImage.SequenceOrder + 1) of @_selectedViewImages.Count</span>
                            @if (_selectedImage.Anomalies.Any())
                            {
                                <span class="defect-count-badge">@_selectedImage.Anomalies.Count defects</span>
                            }
                        }
                    </div>
                    
                    <button class="btn-delete-image" @onclick="DeleteCurrentImage" disabled="@(_selectedImage == null)" title="Delete Current Image">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            
            <!-- Top Header / Controls -->
            <div class="inspection-header">
                <div class="blade-info">
                    <span class="blade-id">@(_selectedBlade?.SerialNumber ?? "No Blade")</span>
                    <span class="project-info">@_selectedView - @GetViewLabel(_selectedView)</span>
                </div>
                
                <div class="canvas-controls">
                    <button class="btn-icon" @onclick="ZoomIn" title="Zoom In">+</button>
                    <span class="zoom-level">@(_zoomLevel.ToString("0.0"))x</span>
                    <button class="btn-icon" @onclick="ZoomOut" title="Zoom Out">-</button>
                    <button class="btn-icon" @onclick="ResetView" title="Reset View">‚ü≤</button>
                    <div class="divider"></div>
                    <!-- Maximize Button -->
                    <button class="btn-icon" @onclick="ToggleVisualMode" title="Maximize View">
                        @if (_isVisualMode) { <span>‚úï</span> } else { <span>‚õ∂</span> }
                    </button>
                </div>
            </div>

            <div class="main-content" style="flex: 1; position: relative; overflow: hidden;">
                <!-- Center Canvas Area -->
                <div class="canvas-panel" style="width: 100%; height: 100%;">
                    <div class="canvas-toolbar">
                        <div class="toolbar-group">
                            <!-- Zoom Controls Only -->
                            <button class="btn btn-icon btn-secondary" @onclick="ZoomOut" title="Zoom Out"> - </button>
                            <span class="zoom-display">@((_zoomLevel * 100).ToString("F0"))%</span>
                            <button class="btn btn-icon btn-secondary" @onclick="ZoomIn" title="Zoom In"> + </button>
                        </div>
                        
                        <div class="toolbar-group">
                            <span class="mode-indicator inspect">
                                @(_selectedBlade?.SerialNumber ?? "-") / @(_selectedView ?? "-") / @(_selectedImage?.SequenceOrder + 1 ?? 0)
                            </span>
                        </div>
                    </div>

                    <div class="canvas-container-wrapper" id="canvasViewer">
                        @if (string.IsNullOrEmpty(_imageUrl))
                        {
                            <div class="empty-state" style="width: 100%;">
                                <svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                                <h3>No Image Selected</h3>
                                <p>Select or upload an image for @(_selectedView ?? "this view")</p>
                            </div>
                        }
                        else
                        {
                            <div class="canvas-container" id="canvasContainer">
                                <img id="bladeImage" src="@_imageUrl" @onload="OnImageLoaded" alt="Blade Image" />
                                <canvas id="inspectionCanvas"></canvas>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDEBAR: Actions -->
        <div class="damage-details-panel">
            <div class="panel-header-row">
                 <div class="panel-title">Defect Entry</div>
            </div>
            
            <!-- Global Actions -->
            <div class="action-buttons" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-primary" @onclick="GenerateReport" style="flex: 1;">
                    üìÑ Report
                </button>
            </div>

            <!-- Current Defect Form (Always Visible when drawing) -->
            @if (_currentAnomaly != null)
            {
                <div class="panel-title" style="margin-top: 0; margin-bottom: 1rem;">New Defect</div>
                
                <!-- Defect Dimensions Display -->
                <div class="form-group" style="margin-bottom: 15px; background: #1a1a1a; padding: 10px; border-radius: 4px;">
                    <label class="form-label" style="display:block; margin-bottom:5px; color:#0f0; font-size: 0.9rem;">Defect Dimensions</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                        <div>
                            <span style="color: #aaa;">Width: </span>
                            <span style="color: #0f0; font-weight: bold;">@_currentDefectWidthPx.ToString("F0") px</span>
                            <br />
                            <span style="color: #aaa; font-size: 0.75rem;">(@_currentDefectWidthPct.ToString("F1")% of image)</span>
                        </div>
                        <div>
                            <span style="color: #aaa;">Height: </span>
                            <span style="color: #0f0; font-weight: bold;">@_currentDefectHeightPx.ToString("F0") px</span>
                            <br />
                            <span style="color: #aaa; font-size: 0.75rem;">(@_currentDefectHeightPct.ToString("F1")% of image)</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Severity (1-5)</label>
                    <select class="form-select" @bind="_currentAnomaly.Severity">
                        <option value="1">1 - Cosmetic</option>
                        <option value="2">2 - Minor</option>
                        <option value="3">3 - Medium</option>
                        <option value="4">4 - Serious</option>
                        <option value="5">5 - Very Serious</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" @bind="_currentAnomaly.Type">
                        <option value="Erosion">Erosion</option>
                        <option value="Crack">Crack</option>
                        <option value="Pinholes">Pinholes</option>
                        <option value="Peeling">Peeling</option>
                        <option value="Flaking">Flaking</option>
                        <option value="Discoloration">Discoloration</option>
                        <option value="Damaged or Misaligned">Damaged or Misaligned</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Blade Side</label>
                    <select class="form-select" @bind="_currentAnomaly.BladeSide">
                        <option value="">-- Auto (Current View) --</option>
                        <option value="PS">Pressure Side</option>
                        <option value="SS">Suction Side</option>
                        <option value="LE">Leading Edge</option>
                        <option value="TE">Trailing Edge</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" @onclick="SaveAnomaly" style="flex: 1;">Save Defect</button>
                    <button class="btn btn-secondary" @onclick="CancelDefect" style="flex: 1; background: #442222; border-color: #663333;">Cancel</button>
                </div>
            }
            else
            {
                <div style="padding: 20px; text-align: center; color: var(--text-muted); border: 2px dashed #444; border-radius: 4px; margin-top: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem;">‚úèÔ∏è Draw a box on the image to add a defect</p>
                </div>
            }

            <div class="panel-title" style="margin-top: 1.5rem;">Image Details</div>
             @if (_selectedImage != null)
             {
                 <div class="image-info-card">
                     <div class="info-row">
                         <span class="info-label">View</span>
                         <span class="info-value">@_selectedView</span>
                     </div>
                     <div class="info-row">
                         <span class="info-label">Image #</span>
                         <span class="info-value">@(_selectedImage.SequenceOrder + 1)</span>
                     </div>
                     <div class="info-row">
                         <span class="info-label">Defects</span>
                         <span class="info-value">@_selectedImage.Anomalies.Count</span>
                     </div>
                 </div>
             }
             else
             {
                 <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">No image selected</p>
             }

            <div class="panel-title" style="margin-top: 1.5rem;">Saved Defects</div>
            
            @if (_selectedAnomaly != null)
            {
                <div class="damage-form">
                    <div class="form-group">
                        <label class="form-label">Severity (1-5)</label>
                        <select class="form-select" @bind="_selectedAnomaly.Severity">
                            <option value="1">1 - Cosmetic</option>
                            <option value="2">2 - Minor</option>
                            <option value="3">3 - Medium</option>
                            <option value="4">4 - Serious</option>
                            <option value="5">5 - Very Serious</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" @bind="_selectedAnomaly.Type">
                            <option value="Erosion">Erosion</option>
                            <option value="Crack">Crack</option>
                            <option value="Pinholes">Pinholes</option>
                            <option value="Peeling">Peeling</option>
                            <option value="Flaking">Flaking</option>
                            <option value="Discoloration">Discoloration</option>
                            <option value="Damaged or Misaligned">Damaged or Misaligned</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Blade Side</label>
                        <select class="form-select" @bind="_selectedAnomaly.BladeSide">
                            <option value="PS">Pressure Side</option>
                            <option value="SS">Suction Side</option>
                            <option value="LE">Leading Edge</option>
                            <option value="TE">Trailing Edge</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary btn-block" @onclick="SaveAnomaly">
                        Update Defect
                    </button>
                    <button class="btn btn-secondary btn-block" @onclick="DeleteAnomaly" style="margin-top: 5px; background: #442222; border-color: #663333;">
                        Delete
                    </button>
                </div>
            }
            else if (_currentAnomaly == null)
            {
                <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 1rem;">
                    Select a saved defect to edit
                </p>
            }
        </div>
    </div>
</div>

<style>
    /* Full-screen Inspection Styles - 3 Column Grid */
    .inspection-layout {
        display: grid;
        grid-template-columns: 250px 1fr 300px;
        height: calc(100vh - 60px); /* Adjust for header */
        overflow: hidden;
    }
    
    .blade-schematic-panel {
        /* Fixed left sidebar */
        width: 250px;
        background: #1e1e1e;
        z-index: 10;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 15px;
    }
    
    .canvas-panel {
        position: relative;
        background: #0d0d0d;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .damage-details-panel {
        width: 300px;
        background: #1e1e1e;
        overflow-y: auto;
        padding: 15px;
    }
    
    .canvas-container-wrapper {
        flex: 1;
        overflow: hidden;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #0d0d0d;
    }
    
    .canvas-container {
        transform-origin: 0 0; 
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }

    /* Top Image Navigation Bar */
    .image-navigation-bar {
        background: #1a1a1a;
        border-bottom: 2px solid #0f0;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        min-height: 50px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .image-nav-content {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
    }
    
    .nav-arrow-btn {
        background: #2a2a2a;
        border: 2px solid #444;
        color: #0f0;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        transition: all 0.2s;
        min-width: 50px;
    }
    
    .nav-arrow-btn:hover:not(:disabled) {
        background: #0f0;
        color: #000;
        border-color: #0f0;
    }
    
    .nav-arrow-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .image-number-list {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        flex: 1;
        align-items: center;
        overflow-x: auto;
        padding: 5px 0;
    }
    
    .image-number-btn {
        background: #2a2a2a;
        border: 2px solid #444;
        color: #aaa;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s;
        min-width: 42px;
        position: relative;
    }
    
    .image-number-btn:hover {
        background: #333;
        border-color: #666;
        color: #fff;
        transform: translateY(-2px);
    }
    
    .image-number-btn.active {
        background: #0f0;
        color: #000;
        border-color: #0f0;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
    
    .image-number-btn.has-defects::after {
        content: '';
        position: absolute;
        top: 2px;
        right: 2px;
        width: 6px;
        height: 6px;
        background: #ff4444;
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(255, 68, 68, 0.8);
    }
    
    .image-info-compact {
        display: flex;
        gap: 10px;
        align-items: center;
        color: #aaa;
        font-size: 0.85rem;
        white-space: nowrap;
        padding: 0 10px;
        border-left: 1px solid #444;
    }
    
    .defect-count-badge {
        background: #ff4444;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .btn-delete-image {
        background: #442222;
        border: 2px solid #663333;
        color: #ff6666;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
    }
    
    .btn-delete-image:hover:not(:disabled) {
        background: #663333;
        border-color: #ff4444;
        color: #fff;
    }
    
    .btn-delete-image:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .btn-upload-full {
        background: #0f0;
        color: #000;
        border: 2px solid #0f0;
        padding: 12px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: block;
        text-align: center;
        transition: all 0.2s;
    }
    
    .btn-upload-full:hover {
        background: #00cc00;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 255, 0, 0.3);
    }

    .view-selector-btn {
        background: #2a2a2a;
        border: 2px solid #444;
        color: #aaa;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .view-selector-btn:hover {
        background: #333;
        border-color: #666;
        color: #fff;
    }

    .view-selector-btn.active {
        background: #0f0;
        color: #000;
        border-color: #0f0;
        font-weight: bold;
    }
    
     /* Visual Mode Styles - FIXED */
    .visual-mode {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9999;
        background: #000;
        display: flex;
        flex-direction: column;
    }

    .visual-mode .app-header, 
    .visual-mode .blade-schematic-panel,
    .visual-mode .damage-details-panel,
    .visual-mode .inspection-header,
    .visual-mode .canvas-toolbar,
    .visual-mode .image-navigation-bar
    {
        display: none !important;
    }

    .visual-mode .center-panel {
        width: 100%;
        height: 100%;
        flex: 1;
    }

    .visual-mode .main-content {
        height: 100%;
        width: 100%;
    }

    .visual-mode .canvas-container-wrapper {
        width: 100vw;
        height: 100vh;
        background: #000;
    }

    .visual-controls {
        display: none; 
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 20, 20, 0.85);
        backdrop-filter: blur(5px);
        padding: 12px 25px;
        border-radius: 50px;
        gap: 20px;
        z-index: 10001;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .visual-mode .visual-controls {
        display: flex;
    }
</style>

    <!-- Visual Mode Controls -->
    <div class="visual-controls">
        <button class="floating-btn" @onclick="PrevImage" title="Previous Image">‚ùÆ</button>
        <button class="floating-btn" @onclick="ZoomOut" title="Zoom Out">-</button>
        <button class="floating-btn primary" @onclick="ToggleVisualMode" title="Exit Visual Mode">‚úï</button>
        <button class="floating-btn" @onclick="ZoomIn" title="Zoom In">+</button>
        <button class="floating-btn" @onclick="NextImage" title="Next Image">‚ùØ</button>
    </div>
    
    @code {
        [Parameter]
        public Guid? ProjectId { get; set; }

        private InputFile? _fileInput;
        private DotNetObjectReference<Inspection>? _dotNetRef;
        private bool _isCanvasInitialized = false;
        private bool _isVisualMode = false;

        // Project data
        private InspectionProject? _project;
        private Blade? _selectedBlade;
        private Anomaly? _selectedAnomaly;
        
        // View state
        private string _selectedView = "PS";
        private InspectionImage? _selectedImage;
        private List<InspectionImage> _selectedViewImages = new();

        // Image state
        private string _imageUrl = string.Empty;

        // Mode state
        private string _currentMode = "inspect";

        // Zoom state
        private double _zoomLevel = 1.0;

        // Defect dimensions display
        private double _currentDefectWidthPx = 0;
        private double _currentDefectHeightPx = 0;
        private double _currentDefectWidthPct = 0;
        private double _currentDefectHeightPct = 0;

        // Current annotation
        private Anomaly? _currentAnomaly;
        private int _currentCanvasBoxIndex = -1;

        protected override void OnInitialized()
        {
            if (ProjectId.HasValue)
            {
                _project = DashboardService.GetProjectById(ProjectId.Value);
                if (_project != null && _project.Blades.Count > 0)
                {
                    SelectBlade(_project.Blades[0]);
                }
            }
        }
        
        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender)
            {
                _dotNetRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("setupKeyboardNavigation", _dotNetRef);
            }
        }

        private void SelectBlade(Blade blade)
        {
            Logger.LogInformation("Blade selected: {BladeSerial}, View: {View}", blade.SerialNumber, _selectedView);
            _selectedBlade = blade;
            _selectedAnomaly = null;
            _selectedView = "PS";
            
            if (!blade.Views.Any(v => v.Side == "PS")) blade.Views.Add(new BladeView { Side = "PS" });
            if (!blade.Views.Any(v => v.Side == "SS")) blade.Views.Add(new BladeView { Side = "SS" });
            if (!blade.Views.Any(v => v.Side == "LE")) blade.Views.Add(new BladeView { Side = "LE" });
            if (!blade.Views.Any(v => v.Side == "TE")) blade.Views.Add(new BladeView { Side = "TE" });
            
            UpdateSelectedViewImages();
            StateHasChanged();
        }

        private void SelectView(string view)
        {
            Logger.LogInformation("View changed to: {View}", view);
            _selectedView = view;
            _selectedImage = null;
            _imageUrl = string.Empty;
            _isCanvasInitialized = false;
            _currentAnomaly = null;
            
            UpdateSelectedViewImages();
            StateHasChanged();
        }

        private void UpdateSelectedViewImages()
        {
            if (_selectedBlade == null || string.IsNullOrEmpty(_selectedView))
            {
                _selectedViewImages = new();
                return;
            }

            var view = _selectedBlade.Views.FirstOrDefault(v => v.Side == _selectedView);
            _selectedViewImages = view?.Images.OrderBy(i => i.SequenceOrder).ToList() ?? new();
        }

        private string GetViewLabel(string side) => side switch
        {
            "PS" => "Pressure Side",
            "SS" => "Suction Side",
            "LE" => "Leading Edge",
            "TE" => "Trailing Edge",
            _ => side
        };
        
        private void SelectAnomaly(Anomaly anomaly)
        {
            _selectedAnomaly = anomaly;
            StateHasChanged();
        }

        private async Task OnImageLoaded()
        {
            if (!_isCanvasInitialized && _dotNetRef != null)
            {
                await Task.Delay(100);
                var result = await JSRuntime.InvokeAsync<bool>(
                    "inspectionCanvas.initialize", 
                    "inspectionCanvas", 
                    _dotNetRef,
                    "bladeImage",
                    "canvasContainer");
                _isCanvasInitialized = result;
                await SetModeInternal("inspect");
                await ResetView();
            }
        }
        
        private async Task SetModeInternal(string mode)
        {
            _currentMode = mode;
            if (_isCanvasInitialized)
            {
                await JSRuntime.InvokeVoidAsync("inspectionCanvas.setMode", mode);
            }
            StateHasChanged();
        }

        [JSInvokable]
        public void ReceiveSelection(double x, double y, double width, double height, double refWidth, double refHeight)
        {
            Logger.LogInformation("Defect box drawn: {Width}x{Height} px at ({X}, {Y})", width, height, x, y);
            
            _currentDefectWidthPx = width;
            _currentDefectHeightPx = height;
            _currentDefectWidthPct = (width / refWidth) * 100;
            _currentDefectHeightPct = (height / refHeight) * 100;
            _currentCanvasBoxIndex = _selectedImage?.Anomalies.Count ?? 0;
            
            _currentAnomaly = new Anomaly
            {
                AnomalyId = $"NEW#{DateTime.Now.Ticks % 10000:X4}",
                RadiusMeters = _selectedImage?.PositionMeters ?? 0, 
                BladeSide = _selectedView ?? "PS",
                AreaCm2 = (width * height) / 10000,
                WidthCm = (width / refWidth) * 100,
                Coordinates = new ImageCoordinates 
                { 
                    X = x, 
                    Y = y, 
                    Width = width, 
                    Height = height,
                    ReferenceWidth = refWidth,
                    ReferenceHeight = refHeight
                }
            };
            
            StateHasChanged();
        }

        [JSInvokable]
        public void ReceiveZoomChange(double newZoom)
        {
            _zoomLevel = newZoom;
            StateHasChanged();
        }

        [JSInvokable]
        public void NavigateNext()
        {
            NextImage();
        }

        [JSInvokable]
        public void NavigatePrevious()
        {
            PrevImage();
        }

        private void SaveAnomaly()
        {
            if (_currentAnomaly != null && _selectedBlade != null)
            {
                if (string.IsNullOrEmpty(_currentAnomaly.BladeSide) || _currentAnomaly.BladeSide == "Unknown")
                {
                    _currentAnomaly.BladeSide = _selectedView;
                }

                Logger.LogInformation("Defect saved: Type={Type}, Severity={Severity}, Side={Side}, Blade={Blade}",
                    _currentAnomaly.Type, _currentAnomaly.Severity, _currentAnomaly.BladeSide, _selectedBlade.SerialNumber);

                _selectedBlade.Anomalies.Add(_currentAnomaly);
                
                if (_selectedImage != null)
                {
                    _selectedImage.Anomalies.Add(_currentAnomaly);
                }
                
                _currentAnomaly = null;
                StateHasChanged();
            }
        }

        private async Task CancelDefect()
        {
            try
            {
                Logger.LogInformation("Defect canceled - removing box at index {Index}", _currentCanvasBoxIndex);
                
                if (_isCanvasInitialized && _currentCanvasBoxIndex >= 0)
                {
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("inspectionCanvas.removeBoxByIndex", _currentCanvasBoxIndex);
                    }
                    catch (Exception ex)
                    {
                        Logger.LogWarning(ex, "Could not remove box by index, trying removeLastBox");
                        await JSRuntime.InvokeVoidAsync("inspectionCanvas.removeLastBox");
                    }
                }
                
                _currentAnomaly = null;
                _currentCanvasBoxIndex = -1;
                _currentDefectWidthPx = 0;
                _currentDefectHeightPx = 0;
                _currentDefectWidthPct = 0;
                _currentDefectHeightPct = 0;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error occurred while canceling the defect.");
            }
            finally
            {
                StateHasChanged();
            }
        }
          
        private async Task ZoomIn()
        {
            _zoomLevel = Math.Min(_zoomLevel + 0.25, 3.0);
            if (_isCanvasInitialized)
            {
                await JSRuntime.InvokeVoidAsync("inspectionCanvas.setZoom", _zoomLevel);
            }
            StateHasChanged();
        }


        private async Task ZoomOut()
        {
            _zoomLevel = Math.Max(_zoomLevel - 0.25, 0.25);
            if (_isCanvasInitialized)
            {
                await JSRuntime.InvokeVoidAsync("inspectionCanvas.setZoom", _zoomLevel);
            }
            StateHasChanged();
        }

        private async Task ResetView()
        {
            _zoomLevel = 1.0;
            if (_isCanvasInitialized)
            {
                await JSRuntime.InvokeVoidAsync("inspectionCanvas.resetView");
            }
            StateHasChanged();
        }

        private void SelectImageDirect(InspectionImage img)
        {
            _selectedImage = img;
            _imageUrl = img.ImageUrl;
            _selectedView = _selectedBlade?.Views.FirstOrDefault(v => v.Images.Contains(img))?.Side ?? _selectedView;
            
            _isCanvasInitialized = false; 
            _currentAnomaly = null;
            StateHasChanged();
        }
        
        private async Task DeleteAnomaly()
        {
             if (_selectedAnomaly != null)
             {
                 if (_selectedBlade != null && _selectedBlade.Anomalies.Contains(_selectedAnomaly))
                 {
                     _selectedBlade.Anomalies.Remove(_selectedAnomaly);
                 }
                 
                 if (_selectedImage != null && _selectedImage.Anomalies.Contains(_selectedAnomaly))
                 {
                     _selectedImage.Anomalies.Remove(_selectedAnomaly);
                 }
                 
                 await JSRuntime.InvokeVoidAsync("inspectionCanvas.removeLastBox");
                 
                 _selectedAnomaly = null;
                 
                 StateHasChanged();
             }
        }

        private async Task ToggleVisualMode()
        {
            _isVisualMode = !_isVisualMode;
            await Task.Delay(50); 
            
            if (_isCanvasInitialized)
            {
                await JSRuntime.InvokeVoidAsync("inspectionCanvas.resetView");
            }
            
            StateHasChanged();
        }
        
        private void NextImage()
        {
            if (_selectedViewImages.Count == 0 || _selectedImage == null) return;
            
            var currentIndex = _selectedViewImages.IndexOf(_selectedImage);
            if (currentIndex < _selectedViewImages.Count - 1)
            {
                SelectImageDirect(_selectedViewImages[currentIndex + 1]);
            }
        }
        
        private void PrevImage()
        {
            if (_selectedViewImages.Count == 0 || _selectedImage == null) return;
            
            var currentIndex = _selectedViewImages.IndexOf(_selectedImage);
            if (currentIndex > 0)
            {
                SelectImageDirect(_selectedViewImages[currentIndex - 1]);
            }
        }

        private bool CanNavigateNext()
        {
            if (_selectedViewImages.Count == 0 || _selectedImage == null) return false;
            var currentIndex = _selectedViewImages.IndexOf(_selectedImage);
            return currentIndex < _selectedViewImages.Count - 1;
        }

        private bool CanNavigatePrev()
        {
            if (_selectedViewImages.Count == 0 || _selectedImage == null) return false;
            var currentIndex = _selectedViewImages.IndexOf(_selectedImage);
            return currentIndex > 0;
        }

        private void DeleteCurrentImage()
        {
            if (_selectedImage != null)
            {
                DeleteImage(_selectedImage);
            }
        }

        private async Task GenerateReport()
        {
            if (_selectedBlade == null) return;
            
            Logger.LogInformation("Generating enhanced report for blade: {BladeSerial}", _selectedBlade.SerialNumber);
            
            var sb = new System.Text.StringBuilder();
            sb.Append("<!DOCTYPE html><html><head><title>Inspection Report - ");
            sb.Append(_selectedBlade.SerialNumber);
            sb.Append("</title>");
            
            sb.Append($"<base href='{Navigation.BaseUri}' />");
            
            sb.Append("<style>");
            sb.Append("body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; background: #f5f5f5; }");
            sb.Append("h1 { border-bottom: 3px solid #333; padding-bottom: 10px; margin-bottom: 20px; }");
            sb.Append("h2 { margin-top: 30px; border-bottom: 2px solid #666; padding-bottom: 8px; color: #444; }");
            sb.Append("h3 { color: #555; margin-top: 25px; }");
            sb.Append(".summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }");
            sb.Append(".summary-table th, .summary-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }");
            sb.Append(".summary-table th { background-color: #2c3e50; color: white; font-weight: 600; }");
            sb.Append(".severity-1 { background-color: #e0f7fa; } .severity-2 { background-color: #fff3cd; }");
            sb.Append(".severity-3 { background-color: #ffe0b2; } .severity-4 { background-color: #ffccbc; } .severity-5 { background-color: #ffcdd2; }");
            sb.Append(".defect-entry { margin: 30px 0; page-break-inside: avoid; border: 2px solid #ddd; padding: 25px; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }");
            sb.Append(".defect-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: -25px -25px 20px -25px; border-radius: 6px 6px 0 0; }");
            sb.Append(".defect-header h4 { margin: 0; font-size: 1.2rem; }");
            sb.Append(".defect-image-container { position: relative; display: inline-block; max-width: 100%; margin: 20px 0; }");
            sb.Append(".main-image-wrapper { position: relative; display: inline-block; width: 100%; }");
            sb.Append(".report-img { max-width: 100%; height: auto; display: block; border: 2px solid #ccc; border-radius: 4px; }");
            sb.Append(".single-defect-box { position: absolute; border: 3px solid #ff0000; background-color: rgba(255, 0, 0, 0.15); box-sizing: border-box; }");
            sb.Append(".defect-marker { position: absolute; top: -25px; left: -3px; background: #ff0000; color: white; font-size: 0.75rem; font-weight: bold; padding: 4px 8px; white-space: nowrap; border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }");
            sb.Append(".magnified-inset { position: absolute; top: 20px; right: 20px; width: 250px; height: 250px; border: 4px solid #ff0000; box-shadow: 0 8px 16px rgba(0,0,0,0.4); overflow: hidden; background: white; z-index: 10; border-radius: 4px; }");
            sb.Append(".magnified-inset::before { content: 'üîç Magnified View'; position: absolute; top: 0; left: 0; right: 0; background: rgba(255, 0, 0, 0.95); color: white; font-size: 0.7rem; font-weight: bold; padding: 5px; text-align: center; z-index: 11; }");
            sb.Append(".magnified-img { position: absolute; top: 25px; left: 0; width: 100%; height: calc(100% - 25px); object-fit: none; }");
            sb.Append(".defect-details { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.95rem; }");
            sb.Append(".defect-details td { padding: 10px; border: 1px solid #ddd; }");
            sb.Append(".defect-details td:first-child { font-weight: 600; background: #f8f9fa; width: 35%; color: #555; }");
            sb.Append(".defect-details td:nth-child(2) { background: white; }");
            sb.Append("@media print { .no-print { display: none !important; } }");
            sb.Append(".toolbar { background: white; padding: 15px; margin-bottom: 20px; border-radius: 6px; border: 1px solid #ddd; display: flex; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }");
            sb.Append(".btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }");
            sb.Append(".btn-primary { background: #007bff; color: white; } .btn-primary:hover { background: #0056b3; transform: translateY(-1px); }");
            sb.Append(".btn-secondary { background: #6c757d; color: white; } .btn-secondary:hover { background: #545b62; transform: translateY(-1px); }");
            sb.Append("</style>");
            
            sb.Append("<script>");
            sb.Append("function downloadWord() {");
            sb.Append("  var header = \"<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>\";");
            sb.Append("  var content = document.documentElement.innerHTML.replace(/<button.*?>.*?<\\/button>/g, '').replace(/class=\"no-print\"/g, 'style=\"display:none\"');");
            sb.Append("  content = content.replace(/src=\"\\//g, 'src=\"' + window.location.origin + '/');");
            sb.Append("  var blob = new Blob(['\\ufeff', header + content + '</html>'], { type: 'application/msword' });");
            sb.Append("  var url = URL.createObjectURL(blob);");
            sb.Append("  var link = document.createElement('a'); link.href = url; link.download = 'Inspection_Report.doc'; document.body.appendChild(link); link.click(); document.body.removeChild(link);");
            sb.Append("}");
            sb.Append("</script>");
            
            sb.Append("</head><body>");
            sb.Append("<div class='toolbar no-print'>");
            sb.Append("<button class='btn btn-primary' onclick='window.print()'>üñ®Ô∏è Print to PDF</button>");
            sb.Append("<button class='btn btn-secondary' onclick='downloadWord()'>üíæ Download Word (.doc)</button>");
            sb.Append("</div>");
            
            sb.Append($"<h1>üîç Inspection Report: {_selectedBlade.SerialNumber}</h1>");
            sb.Append($"<p><strong>Date:</strong> {DateTime.Now:MMMM dd, yyyy}</p>");
            sb.Append($"<p><strong>Total Defects Found:</strong> {_selectedBlade.Anomalies.Count}</p>");
            
            sb.Append("<h2>üìä Executive Summary</h2>");
            sb.Append("<table class='summary-table'><thead><tr><th>#</th><th>Severity</th><th>Type</th><th>Side</th><th>Dimensions (px)</th><th>Area (px¬≤)</th></tr></thead><tbody>");
            
            int summaryIndex = 1;
            foreach(var a in _selectedBlade.Anomalies.OrderByDescending(x => x.Severity))
            {
                var areaPixels = (a.Coordinates?.Width ?? 0) * (a.Coordinates?.Height ?? 0);
                sb.Append($"<tr class='severity-{a.Severity}'>");
                sb.Append($"<td>{summaryIndex++}</td>");
                sb.Append($"<td><strong>{a.Severity}</strong></td>");
                sb.Append($"<td>{a.Type}</td>");
                sb.Append($"<td>{a.BladeSide}</td>");
                sb.Append($"<td>{a.Coordinates?.Width:F0} √ó {a.Coordinates?.Height:F0}</td>");
                sb.Append($"<td>{areaPixels:N0}</td>");
                sb.Append("</tr>");
            }
            sb.Append("</tbody></table>");
            
            sb.Append("<h2>üî¨ Detailed Defect Analysis</h2>");
            sb.Append("<p style='color: #666; font-style: italic;'>Each defect is shown on a separate image with a magnified inset view for detailed inspection.</p>");
            
            var allDefects = new List<(Anomaly Anomaly, string ImageUrl, string View, int DefectNumber)>();
            int defectNumber = 1;
            
            foreach (var view in new[] { "PS", "SS", "LE", "TE" })
            {
                var viewData = _selectedBlade.Views.FirstOrDefault(v => v.Side == view);
                if (viewData != null)
                {
                    foreach (var img in viewData.Images.OrderBy(i => i.SequenceOrder))
                    {
                        foreach (var anomaly in img.Anomalies.OrderByDescending(a => a.Severity))
                        {
                            allDefects.Add((anomaly, img.ImageUrl, view, defectNumber++));
                        }
                    }
                }
            }
            
            Logger.LogInformation("Generating {DefectCount} individual defect images", allDefects.Count);
            
            foreach (var defectData in allDefects)
            {
                var defect = defectData.Anomaly;
                var coords = defect.Coordinates;
                
                if (coords == null || coords.ReferenceWidth == 0 || coords.ReferenceHeight == 0) continue;
                
                sb.Append("<div class='defect-entry'>");
                sb.Append($"<div class='defect-header'><h4>Defect #{defectData.DefectNumber}: {defect.Type} (Severity {defect.Severity})</h4></div>");
                
                var areaPixels = coords.Width * coords.Height;
                var totalImageArea = coords.ReferenceWidth * coords.ReferenceHeight;
                var areaPercentage = (areaPixels / totalImageArea) * 100;
                var avgSize = (coords.Width + coords.Height) / 2;
                double magFactor = avgSize < 100 ? 3.0 : (avgSize < 300 ? 2.5 : 2.0);
                var centerX = coords.X + (coords.Width / 2);
                var centerY = coords.Y + (coords.Height / 2);
                var leftPct = (coords.X / coords.ReferenceWidth) * 100;
                var topPct = (coords.Y / coords.ReferenceHeight) * 100;
                var widthPct = (coords.Width / coords.ReferenceWidth) * 100;
                var heightPct = (coords.Height / coords.ReferenceHeight) * 100;
                
                sb.Append("<div class='defect-image-container'>");
                sb.Append("<div class='main-image-wrapper'>");
                sb.Append($"<img src='{defectData.ImageUrl}' class='report-img' alt='Defect Image' />");
                
                var boxStyle = $"left: {leftPct:F2}%; top: {topPct:F2}%; width: {widthPct:F2}%; height: {heightPct:F2}%;";
                sb.Append($"<div class='single-defect-box' style='{boxStyle}'>");
                sb.Append($"<div class='defect-marker'>#{defectData.DefectNumber}</div>");
                sb.Append("</div>");
                
                var centerXPct = (centerX / coords.ReferenceWidth) * 100;
                var centerYPct = (centerY / coords.ReferenceHeight) * 100;
                
                sb.Append("<div class='magnified-inset'>");
                sb.Append($"<img src='{defectData.ImageUrl}' class='magnified-img' style='transform: scale({magFactor}); transform-origin: {centerXPct:F2}% {centerYPct:F2}%;' alt='Magnified View' />");
                sb.Append("</div>");
                
                sb.Append("</div>");
                sb.Append("</div>");
                
                sb.Append("<table class='defect-details'>");
                sb.Append($"<tr><td>üìç Location</td><td>{defectData.View} - {GetViewLabel(defectData.View)}</td></tr>");
                sb.Append($"<tr><td>‚ö†Ô∏è Severity Level</td><td><strong>Level {defect.Severity}</strong></td></tr>");
                sb.Append($"<tr><td>üè∑Ô∏è Defect Type</td><td>{defect.Type}</td></tr>");
                sb.Append($"<tr><td>üìè Dimensions</td><td>{coords.Width:F1} √ó {coords.Height:F1} pixels</td></tr>");
                sb.Append($"<tr><td>üìê Area (Pixels)</td><td><strong>{areaPixels:N0} px¬≤</strong></td></tr>");
                sb.Append($"<tr><td>üìä Area (% of Image)</td><td>{areaPercentage:F3}%</td></tr>");
                sb.Append($"<tr><td>üîç Magnification</td><td>{magFactor:F1}x</td></tr>");
                
                if (!string.IsNullOrEmpty(defect.Recommendation))
                {
                    sb.Append($"<tr><td>ÔøΩ Recommendation</td><td>{defect.Recommendation}</td></tr>");
                }
                
                sb.Append("</table>");
                sb.Append("</div>");
            }
            
            sb.Append("</body></html>");
            
            await JSRuntime.InvokeVoidAsync("constWindowOpen", sb.ToString());
            Logger.LogInformation("Report generation complete with {DefectCount} individual defect sections", allDefects.Count);
        }

        private async Task HandleBulkFileUpload(InputFileChangeEventArgs e)
        {
            if (_selectedBlade == null || string.IsNullOrEmpty(_selectedView)) 
            {
                Logger.LogWarning("File upload attempted without blade or view selected");
                return;
            }

            var fileCount = e.FileCount;
            Logger.LogInformation("File upload started: {FileCount} files for view {View}", fileCount, _selectedView);

            try
            {
                var view = _selectedBlade.Views.FirstOrDefault(v => v.Side == _selectedView);
                if (view == null)
                {
                    view = new BladeView { Side = _selectedView };
                    _selectedBlade.Views.Add(view);
                }

                var files = e.GetMultipleFiles(50); 
                foreach (var file in files)
                {
                    using var stream = file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
                    var url = await FileStorageService.SaveFileAsync(stream, file.Name);
                    
                    view.Images.Add(new InspectionImage 
                    {
                        ImageUrl = url,
                        SequenceOrder = view.Images.Count
                    });
                }
                
                UpdateSelectedViewImages();
                if (_selectedViewImages.Count > 0)
                {
                    SelectImageDirect(_selectedViewImages.First());
                }
                
                Logger.LogInformation("File upload completed: {FileCount} files processed for view {View}", files.Count, _selectedView);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "File upload failed for view {View}", _selectedView);
                throw;
            }
        }
 
        private void DeleteImage(InspectionImage img)
        {
            if (_selectedBlade == null) return;
            
            foreach(var view in _selectedBlade.Views)
            {
                if (view.Images.Remove(img))
                {
                    UpdateSelectedViewImages();
                    
                    // Select another image if available
                    if (_selectedViewImages.Count > 0)
                    {
                        SelectImageDirect(_selectedViewImages.First());
                    }
                    else
                    {
                        _selectedImage = null;
                        _imageUrl = string.Empty;
                    }
                    break;
                }
            }
            
            StateHasChanged();
        }

        private void NavigateBack()
        {
            Navigation.NavigateTo("/");
        }

        public async ValueTask DisposeAsync()
        {
            _dotNetRef?.Dispose();
        }
            }
